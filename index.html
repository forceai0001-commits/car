<!-- 
  ===================================================================
  Copyright (c) 2026 Force Cheng. All rights reserved.
  Created: 2026/1/17
  Last Updated: 2026/01/18
  System: Warehouse Vehicle Booking System (Frontend Client)
  
  License: Proprietary & Confidential
  Contact: Force Cheng
  ===================================================================
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- UI Update: å°‡ç‰ˆæœ¬è™Ÿæ”¹ç‚ºæœ€å¾Œæ›´æ–°æ™‚é–“ -->
    <title>å€‰å„²è»Šè¼›é ç´„ç³»çµ± | Last Updated: 2026/01/18</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-bounce-in { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-track { background-color: #f1f5f9; }
        .modal-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans text-base">

<div id="app" v-cloak class="min-h-screen flex flex-col">
    <nav class="bg-slate-800 text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg tracking-wide"><i class="fa-solid fa-truck-fast mr-2"></i>å€‰å„²é ç´„ç³»çµ±</h1>
            <div class="space-x-1 text-sm">
                <!-- UI Update: é¡¯ç¤ºæ›´æ–°æ—¥æœŸè€Œéç‰ˆæœ¬è™Ÿ -->
                <span class="text-xs text-gray-400 mr-2">Updated: 01/18</span>
                <button @click="view='driver'" :class="view==='driver'?'bg-slate-600 ring-2 ring-slate-400':''" class="px-3 py-2 rounded transition">å¸æ©Ÿ</button>
                <button @click="handleAdminClick" :class="(view==='admin'||view==='admin_login')?'bg-slate-600 ring-2 ring-slate-400':''" class="px-3 py-2 rounded transition">ç®¡ç†</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow w-full max-w-5xl mx-auto p-4 md:p-6 relative">
        <div v-if="errorMsg" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded shadow relative animate-bounce-in">
            <p class="font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>éŒ¯èª¤</p>
            <p>{{ errorMsg }}</p>
            <button @click="errorMsg=''" class="absolute top-2 right-2 text-red-500"><i class="fa-solid fa-times"></i></button>
        </div>

        <div v-if="showSuccessModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full animate-bounce-in my-8 relative">
                <div class="text-center mb-4">
                    <div v-if="!isAutoSwitchedToProj" class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl"><i class="fa-solid fa-check"></i></div>
                    <div v-else class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl"><i class="fa-solid fa-circle-exclamation"></i></div>
                    
                    <h3 class="text-2xl font-bold text-gray-800">ç™»è¨˜å®Œæˆ</h3>
                    
                    <!-- Logic Note: é¡¯ç¤ºè‡ªå‹•åˆ‡æ› Bucket çš„æç¤ºè¨Šæ¯ -->
                    <div v-if="isAutoSwitchedToProj" class="mt-2 bg-orange-50 border border-orange-200 text-orange-800 px-3 py-2 rounded text-sm text-left">
                        <strong><i class="fa-solid fa-triangle-exclamation mr-1"></i> æ³¨æ„ï¼šæœ¬æ™‚æ®µæ¨™æº–åé¡å·²æ»¿</strong><br>
                        ç³»çµ±å·²è‡ªå‹•å°‡æ‚¨è½‰ç‚ºã€Œå°ˆæ¡ˆæ›è™Ÿ (PROJ)ã€ã€‚è«‹ç­‰å€™ç®¡ç†å“¡é€²ä¸€æ­¥é€šçŸ¥æˆ–å®‰æ’ã€‚
                    </div>
                    <div v-else class="mt-1 text-sm text-gray-500">æ‚¨çš„é ç´„è³‡æ–™å·²æˆåŠŸä¸Šå‚³ã€‚</div>
                </div>

                <div class="bg-slate-50 rounded-lg p-4 text-sm border border-slate-200 space-y-2 text-left">
                    <div class="flex justify-between border-b pb-1 border-slate-200">
                        <span class="text-gray-500">é ç´„å–®è™Ÿ</span>
                        <span class="font-bold font-mono text-xs">{{ lastSubmittedData.booking_id }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 border-slate-200">
                        <span class="text-gray-500">é è¨ˆåˆ°é”</span>
                        <span class="font-bold font-mono">{{ lastSubmittedData.eta_datetime ? formatTime(lastSubmittedData.eta_datetime) : '' }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 border-slate-200">
                        <span class="text-gray-500">è»Šç‰Œè™Ÿç¢¼</span>
                        <span class="font-bold">{{ lastSubmittedData.plate_manual }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 border-slate-200">
                        <span class="text-gray-500">å¸æ©Ÿå§“å</span>
                        <span class="font-bold">{{ lastSubmittedData.driver_name }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 border-slate-200">
                        <span class="text-gray-500">ç‰©æµå…¬å¸</span>
                        <span class="font-bold">{{ lastSubmittedData.logistics_company }}</span>
                    </div>
                    <div class="pt-2">
                        <span class="text-gray-500 block mb-2 font-bold text-xs">ç…§ç‰‡ç´€éŒ„ (é è¦½)</span>
                        <img v-if="previewPhotoUrl" :src="previewPhotoUrl" class="w-full h-auto rounded border border-gray-300">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="openPrintView(lastSubmittedData, previewPhotoUrl)" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg transition border border-slate-300">
                        <i class="fa-solid fa-print mr-1"></i>åˆ—å°å–®æ“š
                    </button>
                    <button @click="closeSuccessModal" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-2.5 rounded-lg shadow transition">
                        ç¢ºèªé—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <section v-if="view === 'driver'" class="animate-fade-in">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                    <div><h2 class="text-xl font-bold text-blue-900">å¸æ©Ÿå ±åˆ°ç™»è¨˜</h2><p class="text-xs text-blue-600 mt-1">è«‹å¦‚å¯¦å¡«å¯«ï¼Œæ¨™ç¤º * ç‚ºå¿…å¡«</p></div>
                    <button @click="fillDemo" class="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded shadow-sm hover:bg-blue-50 transition"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>ç¯„ä¾‹</button>
                </div>
                <form @submit.prevent="submitBooking" class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">ä½œæ¥­é¡å‹ <span class="text-red-500">*</span></label><select v-model="form.type" class="w-full border rounded-md p-2.5 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" required><option value="reservation">é ç´„ (Reservation)</option><option value="walkin">ç¾å ´ (Walk-in)</option></select><p v-if="form.type==='walkin'" class="text-xs text-purple-600 mt-1"><i class="fa-solid fa-circle-info mr-1"></i>ç¾å ´å–®å°‡æ­¸é¡ç‚ºå°ˆæ¡ˆ (PROJ)</p></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">é è¨ˆåˆ°é” (ETA) <span class="text-red-500">*</span></label><input type="datetime-local" v-model="form.eta_datetime" class="w-full border rounded-md p-2.5 bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">ç‰©æµå…¬å¸ <span class="text-red-500">*</span></label><input type="text" v-model="form.logistics_company" class="w-full border rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="ä¾‹å¦‚ï¼šæ–°ç«¹ç‰©æµ"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">å¸æ©Ÿå§“å <span class="text-red-500">*</span></label><input type="text" v-model="form.driver_name" class="w-full border rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">è»Šç‰Œè™Ÿç¢¼ <span class="text-red-500">*</span></label><input type="text" v-model="form.plate_manual" class="w-full border rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="ABC-1234"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">è¯çµ¡é›»è©± (æ‰‹æ©Ÿ) <span class="text-red-500">*</span></label><input type="text" v-model="form.phone" class="w-full border rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" required placeholder="0912-345-678"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">Line ID <span class="text-xs text-gray-400 font-normal">(é¸å¡«)</span></label><input type="text" v-model="form.line_id" class="w-full border rounded-md p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šmylineid123"></div>
                    </div>
                    <!-- Photo Upload Section -->
                    <div class="bg-blue-50 p-4 rounded-md border-2 border-dashed border-blue-200"><label class="block text-sm font-bold text-blue-800 mb-2">ğŸ“¸ è»Šè¼›/è²¨ç‰©ç…§ç‰‡ (å¿…å¡« 1å¼µ) <span class="text-red-500">*</span></label><input type="file" ref="photoInput" @change="handleFile($event, 'photo')" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" required></div>
                    <details class="group bg-gray-50 rounded-md border border-gray-200"><summary class="cursor-pointer text-sm font-bold text-gray-600 select-none p-3 flex justify-between items-center"><span>ğŸ”½ å±•é–‹é¸å¡«é …ç›® (åœç•™æ™‚é–“ã€å®¢æˆ¶ã€é™„ä»¶...)</span></summary><div class="p-4 space-y-4 border-t border-gray-200"><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">é è¨ˆåœç•™ (åˆ†)</label><input type="number" v-model="form.stay_minutes" class="w-full border rounded p-2 text-sm"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ¶åç¨±</label><input type="text" v-model="form.customer_name" class="w-full border rounded p-2 text-sm"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨»</label><textarea v-model="form.note" class="w-full border rounded p-2 text-sm" rows="2"></textarea></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å…¶ä»–é™„ä»¶ (æœ€å¤š10å€‹)</label><input type="file" ref="attInput" @change="handleFile($event, 'attachments')" multiple class="block w-full text-xs text-slate-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-gray-200 file:text-gray-700"></div></div></details>
                    <button type="submit" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition-transform active:scale-95 flex justify-center items-center text-lg"><span v-if="loading" class="spinner mr-2"></span><span v-else><i class="fa-solid fa-paper-plane mr-2"></i>æäº¤ç™»è¨˜</span></button>
                </form>
            </div>
        </section>

        <section v-if="view === 'admin_login'" class="animate-fade-in flex items-center justify-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border border-gray-100">
                <div class="text-center mb-6"><div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl"><i class="fa-solid fa-lock"></i></div><h2 class="text-xl font-bold text-slate-800">ç®¡ç†å“¡ç™»å…¥</h2><p class="text-sm text-gray-500 mt-1">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥å­˜å–å¾Œå°</p></div>
                <form @submit.prevent="submitLogin"><div class="mb-6"><input type="password" v-model="adminPasswordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full border-2 border-gray-200 rounded-lg p-3 text-center focus:border-slate-800 focus:outline-none transition text-lg tracking-widest" ref="loginInput" required></div><button type="submit" :disabled="loading" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95"><span v-if="loading" class="spinner mr-2 inline-block align-middle" style="width:16px;height:16px;border-width:2px;"></span><span v-else>é©—è­‰ç™»å…¥</span></button></form>
            </div>
        </section>

        <section v-if="view === 'admin'" class="animate-fade-in space-y-6">
            <div class="bg-white p-4 rounded-lg shadow flex flex-wrap items-center justify-between gap-4 sticky top-0 z-30 border-b border-gray-100">
                <div class="flex items-center gap-3"><div class="text-slate-800 font-bold text-lg"><i class="fa-solid fa-chart-line mr-2"></i>æˆ°æƒ…å®¤</div><input type="date" v-model="adminDate" @change="fetchAdminData" class="border-2 border-slate-200 rounded-md p-1.5 bg-gray-50 font-bold focus:border-slate-500 outline-none"><button @click="fetchAdminData" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center transition" title="é‡æ–°æ•´ç†"><i class="fa-solid fa-rotate-right" :class="{'fa-spin': loading}"></i></button></div>
                <div class="text-xs font-bold flex gap-3 items-center"><span class="flex items-center bg-blue-50 px-2 py-1 rounded border border-blue-100"><div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>STD ä¸€èˆ¬</span><span class="flex items-center bg-purple-50 px-2 py-1 rounded border border-purple-100"><div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>PROJ å°ˆæ¡ˆ</span><button @click="logout" class="ml-2 text-gray-400 hover:text-red-500 font-normal"><i class="fa-solid fa-sign-out-alt mr-1"></i>ç™»å‡º</button></div>
            </div>
            
            <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-8 gap-2">
                <template v-for="n in 24" :key="n-1">
                    <div v-if="getSlot(n-1)" @click="openCapEdit(getSlot(n-1))" class="border rounded p-2 cursor-pointer hover:shadow-md transition bg-white relative overflow-hidden group min-h-[80px] flex flex-col justify-between" :class="{'ring-2 ring-blue-400': editingSlot && editingSlot.hour === getSlot(n-1).hour}">
                        <div class="text-xs font-bold text-gray-400 text-center mb-1">{{ getSlot(n-1).hour }}:00</div>
                        <div class="mb-1"><div class="flex justify-between text-[10px] text-blue-800 font-bold leading-none mb-0.5"><span>S</span><span :class="getSlot(n-1).used_std > getSlot(n-1).cap_std ? 'text-red-600':''">{{ getSlot(n-1).used_std }}/{{ getSlot(n-1).cap_std }}</span></div><div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden"><div class="bg-blue-500 h-full rounded-full" :style="{width: pct(getSlot(n-1).used_std, getSlot(n-1).cap_std)+'%'}"></div></div></div>
                        <div><div class="flex justify-between text-[10px] text-purple-800 font-bold leading-none mb-0.5"><span>P</span><span :class="getSlot(n-1).used_proj > getSlot(n-1).cap_proj ? 'text-red-600':''">{{ getSlot(n-1).used_proj }}/{{ getSlot(n-1).cap_proj }}</span></div><div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden"><div class="bg-purple-500 h-full rounded-full" :style="{width: pct(getSlot(n-1).used_proj, getSlot(n-1).cap_proj)+'%'}"></div></div></div>
                    </div>
                </template>
            </div>
            
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-slate-50 px-4 py-3 border-b border-gray-200 font-bold text-sm text-slate-700 flex justify-between items-center">
                    <span>ç•¶æ—¥é ç´„æ¸…å–® ({{ bookingList ? bookingList.length : 0 }}ç­†)</span>
                    <div class="flex gap-2">
                        <button @click="toggleSortOrder" class="text-xs px-2 py-1 rounded bg-white border border-gray-300 hover:bg-gray-100 transition shadow-sm w-28 text-center font-mono" title="åˆ‡æ›æ’åº">
                            <i class="fa-solid fa-sort mr-1"></i>
                            {{ getSortLabel() }}
                        </button>
                        <span class="text-xs text-gray-400 font-normal self-center">è³‡æ–™ä¾†æºï¼šGoogle Sheets</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead class="bg-gray-100 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">é ç´„å–®è™Ÿ</th>
                                <th class="px-4 py-3">ç³»çµ±æ™‚é–“</th>
                                <th class="px-4 py-3">é è¨ˆåˆ°é”</th>
                                <th class="px-4 py-3">è»Šè™Ÿ (OCR)</th>
                                <th class="px-4 py-3">å¸æ©Ÿ / ç‰©æµ</th>
                                <th class="px-4 py-3">Bucket</th>
                                <th class="px-4 py-3 text-right">è©³æƒ…</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="b in sortedBookingList" :key="b.id" @click="viewDetail(b)" class="hover:bg-blue-50 transition cursor-pointer group">
                                <td class="px-4 py-3 font-mono text-xs text-gray-500 group-hover:text-blue-600" :title="b.booking_id">
                                    {{ b.booking_id ? b.booking_id.slice(-8) : '-' }}
                                </td>
                                <td class="px-4 py-3 font-mono text-xs text-gray-500">
                                    {{ formatTime(b.created_at_sys || b.upload_time_sys, true) }}
                                </td>
                                <td class="px-4 py-3 font-mono text-gray-600 group-hover:text-blue-700 font-bold">
                                    {{ formatTime(b.eta_datetime) }}
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-2">
                                        <div class="font-bold text-gray-800 group-hover:text-blue-900">
                                            {{ b.plate_final || b.plate_manual }}
                                        </div>
                                        <span v-if="b.plate_match_status === 'matched'" class="text-green-500 text-xs"><i class="fa-solid fa-circle-check"></i></span>
                                        <span v-else-if="b.plate_match_status === 'mismatch'" class="text-red-500 text-xs"><i class="fa-solid fa-circle-exclamation"></i></span>
                                    </div>
                                    <div v-if="b.plate_final && b.plate_final !== b.plate_manual" class="text-[10px] text-gray-400 line-through">{{ b.plate_manual }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm font-bold text-gray-700">{{ b.driver_name }}</div>
                                    <div class="text-xs text-gray-500 group-hover:text-blue-600">{{ b.logistics_company }}</div>
                                </td>
                                <td class="px-4 py-3" @click.stop>
                                    <button @click="toggleBucket(b)" :class="b.cap_bucket==='std' ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-purple-100 text-purple-700 border-purple-200'" class="px-2 py-1 rounded border text-xs font-bold hover:opacity-80 transition shadow-sm w-16">{{ b.cap_bucket ? b.cap_bucket.toUpperCase() : 'STD' }}</button>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button class="text-gray-400 hover:text-blue-500 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></button>
                                </td>
                            </tr>
                            <tr v-if="!sortedBookingList || sortedBookingList.length===0"><td colspan="7" class="p-8 text-center text-gray-400">å°šç„¡é ç´„è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div v-if="editingSlot" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="bg-white rounded-xl p-6 w-full max-w-xs shadow-2xl animate-fade-in-up"><h3 class="text-lg font-bold mb-4 text-center border-b pb-2">èª¿æ•´å®¹é‡ ({{ editingSlot.hour }}:00)</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-blue-800 mb-1">STD (ä¸€èˆ¬) ä¸Šé™</label><input type="number" v-model.number="tempCap.std" class="w-full border-2 border-blue-100 rounded-lg p-2 text-center text-lg font-bold text-blue-600 focus:border-blue-500 outline-none"></div><div><label class="block text-xs font-bold text-purple-800 mb-1">PROJ (å°ˆæ¡ˆ) ä¸Šé™</label><input type="number" v-model.number="tempCap.proj" class="w-full border-2 border-purple-100 rounded-lg p-2 text-center text-lg font-bold text-purple-600 focus:border-purple-500 outline-none"></div><div class="flex gap-2 mt-6"><button @click="editingSlot=null" class="flex-1 py-2 text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg font-bold">å–æ¶ˆ</button><button @click="saveCap" class="flex-1 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-bold shadow-lg">å„²å­˜</button></div></div></div></div>
            
            <div v-if="selectedBooking" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="selectedBooking=null">
                <div class="bg-white rounded-xl w-full max-w-md shadow-2xl animate-fade-in-up max-h-[90vh] flex flex-col">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                        <h3 class="text-lg font-bold text-gray-800">
                            <span :class="selectedBooking.cap_bucket==='std'?'bg-blue-500':'bg-purple-500'" class="inline-block w-2 h-2 rounded-full mr-2 mb-1"></span>
                            é ç´„è©³æƒ…
                        </h3>
                        <button @click="selectedBooking=null" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-times"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto modal-scroll space-y-4">
                        <div class="flex items-start gap-4 mb-2">
                            <div class="bg-gray-100 rounded-lg p-3 text-center min-w-[80px]">
                                <div class="text-xs text-gray-500 font-bold uppercase">Time</div>
                                <div class="text-xl font-bold text-gray-800 font-mono">{{ formatTime(selectedBooking.eta_datetime) }}</div>
                            </div>
                            <div class="flex-1">
                                <div class="text-xl font-bold text-gray-800">
                                    {{ selectedBooking.plate_final || selectedBooking.plate_manual }}
                                </div>
                                <div class="text-sm text-gray-600 font-bold">{{ selectedBooking.logistics_company }}</div>
                                <div class="text-xs text-gray-400 mt-1">å¸æ©Ÿï¼š{{ selectedBooking.driver_name }}</div>
                            </div>
                        </div>

                        <hr class="border-dashed border-gray-200">

                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><label class="block text-xs text-gray-400 mb-0.5">é ç´„å–®è™Ÿ</label><div class="font-bold font-mono text-xs">{{ selectedBooking.booking_id }}</div></div>
                            <div><label class="block text-xs text-gray-400 mb-0.5">Bucket</label><div class="font-bold text-blue-600">{{ selectedBooking.cap_bucket }}</div></div>
                            <div><label class="block text-xs text-gray-400 mb-0.5">é ç´„é¡å‹</label><div class="font-bold">{{ selectedBooking.type }}</div></div>
                            <div><label class="block text-xs text-gray-400 mb-0.5">é›»è©±</label><div class="font-mono">{{ selectedBooking.phone }}</div></div>
                            <div><label class="block text-xs text-gray-400 mb-0.5">åœç•™</label><div>{{ selectedBooking.stay_minutes }} åˆ†</div></div>
                            <div class="col-span-2"><label class="block text-xs text-gray-400 mb-0.5">å‚™è¨»</label><div class="bg-gray-50 p-2 rounded">{{ selectedBooking.note || 'ç„¡' }}</div></div>
                        </div>

                        <div class="pt-2 border-t border-slate-200 mt-2">
                            <span class="text-gray-500 block mb-2 text-xs font-bold">ç¾å ´ç…§ç‰‡ç´€éŒ„</span>
                            
                            <div v-if="selectedBooking.photo_file">
                                <div class="mb-2 relative group min-h-[200px] bg-gray-100 rounded border border-gray-300 flex items-center justify-center">
                                    <img 
                                        :src="getDriveImgUrl(selectedBooking.photo_file)" 
                                        class="w-full h-auto rounded shadow-sm object-contain max-h-[400px]" 
                                        referrerpolicy="no-referrer"
                                        loading="lazy"
                                        alt="ç¾å ´ç…§ç‰‡"
                                        @error="$event.target.style.display='none'; $event.target.nextElementSibling.classList.remove('hidden'); $event.target.nextElementSibling.classList.add('flex')"
                                    >
                                    
                                    <div class="hidden flex-col items-center justify-center text-gray-400 p-4 text-center">
                                        <i class="fa-solid fa-image-slash text-2xl mb-2"></i>
                                        <span class="text-xs">é è¦½è¼‰å…¥å¤±æ•—<br>è«‹é»æ“Šä¸‹æ–¹é€£çµ</span>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <a :href="selectedBooking.photo_file" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 hover:underline font-bold">
                                        <i class="fa-solid fa-external-link-alt mr-1"></i> å¦é–‹è¦–çª—æŸ¥çœ‹åŸåœ–
                                    </a>
                                </div>
                            </div>
                            <div v-else class="text-xs text-gray-400 bg-gray-50 p-2 rounded text-center">(ç„¡ç…§ç‰‡)</div>
                            <div v-if="selectedBooking.attachment_files" class="space-y-2 mt-4 border-t border-slate-100 pt-2">
                                <label class="block text-xs font-bold text-gray-500 mb-1">å…¶ä»–é™„ä»¶</label>
                                <a v-for="(att, idx) in parseAttachments(selectedBooking.attachment_files)" :key="idx" :href="att.url" target="_blank" class="flex items-center gap-3 p-2 rounded border border-gray-200 hover:bg-gray-50 transition">
                                    <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center text-gray-500"><i class="fa-solid fa-paperclip"></i></div>
                                    <div class="text-sm text-gray-700 truncate flex-1">{{ att.name }}</div>
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t bg-gray-50 rounded-b-xl flex gap-3">
                        <button @click="openPrintView(selectedBooking, selectedBooking.photo_file)" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg transition border border-slate-300">
                            <i class="fa-solid fa-print mr-1"></i>åˆ—å°å–®æ“š
                        </button>
                        <button @click="toggleBucket(selectedBooking); selectedBooking.cap_bucket = (selectedBooking.cap_bucket==='std'?'proj':'std')" 
                            class="flex-1 py-2.5 rounded-lg font-bold shadow-sm transition text-white"
                            :class="selectedBooking.cap_bucket==='std' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'">
                            <i class="fa-solid fa-exchange-alt mr-2"></i>è½‰ç‚º {{ selectedBooking.cap_bucket==='std' ? 'PROJ' : 'STD' }}
                        </button>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <div v-if="loading" class="fixed inset-0 bg-white/80 z-[100] flex flex-col justify-center items-center backdrop-blur-[2px]"><div class="spinner border-slate-300 border-t-slate-800 mb-3" style="width:40px;height:40px;border-width:4px;"></div><div class="text-slate-800 font-bold animate-pulse">{{ loadingText }}</div></div>
    <!-- Footer Update: ç‰ˆæœ¬è³‡è¨Š -->
    <div class="text-center py-2 text-xs text-gray-400">System Updated: 2026/01/18 | (c) 2026 Force Cheng</div>
</div>

<script>
const { createApp, ref, reactive, onMounted, nextTick, computed } = Vue;
createApp({
    setup() {
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyrc3GTzykHsjEgj6vXd2U95rQFKK3Czwhx1WbudRNjmvKDEgvrEsiY7fwTie6loryvhg/exec'; 
        
        const view = ref('driver');
        const loading = ref(false);
        const loadingText = ref('è™•ç†ä¸­...');
        const errorMsg = ref('');
        const showSuccessModal = ref(false);
        const isAutoSwitchedToProj = ref(false);
        const lastSubmittedData = ref({});
        const previewPhotoUrl = ref('');
        const adminDate = ref('2026-01-17'); 
        
        const isAdminLoggedIn = ref(false);
        const adminPasswordInput = ref('');
        const loginInput = ref(null);

        const form = reactive({ type: 'reservation', eta_datetime: '', logistics_company: '', driver_name: '', plate_manual: '', phone: '', line_id: '', stay_minutes: '', customer_name: '', note: '' });
        const files = reactive({ photo: null, attachments: [] });
        const photoInput = ref(null);
        const attInput = ref(null);

        const capacityGrid = ref({});
        const bookingList = ref([]);
        const editingSlot = ref(null);
        const selectedBooking = ref(null); 
        const tempCap = reactive({ std: 10, proj: 10 });
        
        const sortMode = ref('update_desc'); 

        // [FIX] è™•ç† Drive URL çš„å°å¹«æ‰‹
        // Note: å˜—è©¦è§£æ±ºç›´æ¥é€£çµç„¡æ³•é¡¯ç¤ºå•é¡Œï¼Œå¼·åˆ¶ä½¿ç”¨ thumbnail API
        const getDriveImgUrl = (url) => {
            if (!url) return '';
            if (!url.includes('drive.google.com')) return url;
            try {
                // æŠ“å– file ID
                const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    // sz=w1000 å¼·åˆ¶å–å¾—å¯¬åº¦ 1000px çš„ç¸®åœ–
                    return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
                }
            } catch (e) { console.error(e); }
            return url;
        };

        const callApi = async (payload) => {
            const res = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if(!json.success) throw new Error(json.message);
            return json;
        };

        // Note: åœ–ç‰‡è½‰ Base64 é‚è¼¯ (Client Side)
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); 
            reader.onerror = reject;
        });

        const handleFile = (e, type) => {
            if(type === 'photo') {
                files.photo = e.target.files[0];
            } else {
                files.attachments = Array.from(e.target.files).slice(0, 10);
            }
        };

        const fillDemo = () => {
            // Note: ç”¢ç”Ÿæ¸¬è©¦ç”¨è³‡æ–™ (è‡ªå‹• +8 æ™‚å€)
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const twTime = new Date(utc + (3600000 * 8));
            twTime.setHours(twTime.getHours() + 1, 0, 0, 0); 
            form.eta_datetime = twTime.toISOString().slice(0, 16);

            form.logistics_company = 'é€Ÿé€Ÿé€šç‰©æµ';
            form.driver_name = 'ç‹å°æ˜';
            form.plate_manual = 'RWD-' + Math.floor(Math.random()*999);
            form.phone = '0900123456';
            form.line_id = 'line' + Math.floor(Math.random()*100);
            form.stay_minutes = 30;
            errorMsg.value = '';
        };

        const submitBooking = async () => {
            if(!files.photo) { errorMsg.value = "è«‹ä¸Šå‚³ç…§ç‰‡"; return; }
            loading.value = true; loadingText.value = "æª¢æŸ¥å®¹é‡ä¸¦ä¸Šå‚³ä¸­...";
            errorMsg.value = '';
            
            try {
                const etaDate = new Date(form.eta_datetime);
                const dateStr = etaDate.toISOString().split('T')[0]; 
                const hour = String(etaDate.getHours()).padStart(2, '0');
                const key = `${dateStr}T${hour}`; 

                // Note: å‰ç«¯å…ˆå‘¼å« API æª¢æŸ¥å®¹é‡ (Summary)ï¼Œæ±ºå®š Bucket
                const capRes = await callApi({ action: 'summary', date: dateStr });
                const capData = capRes.data || {};
                const slot = capData[key];

                let forcedBucket = 'std';
                isAutoSwitchedToProj.value = false;

                if (form.type === 'walkin') {
                    forcedBucket = 'proj';
                } else if (slot) {
                    if (slot.used_std >= slot.cap_std) {
                        forcedBucket = 'proj';
                        isAutoSwitchedToProj.value = true;
                    }
                }

                const photoB64 = await fileToBase64(files.photo);
                const attB64s = [];
                for(let f of files.attachments) attB64s.push({ name: f.name, data: await fileToBase64(f) });

                const payload = { 
                    action: 'create', 
                    ...form, 
                    cap_bucket: forcedBucket, 
                    photo: { name: files.photo.name, data: photoB64 }, 
                    attachments: attB64s 
                };

                const res = await callApi(payload);
                
                previewPhotoUrl.value = URL.createObjectURL(files.photo);
                lastSubmittedData.value = { ...form, cap_bucket: forcedBucket, booking_id: res.data.booking_id };

                Object.assign(form, { logistics_company: '', driver_name: '', plate_manual: '', phone: '', line_id: '', note: '' });
                if(photoInput.value) photoInput.value.value = ''; 
                if(attInput.value) attInput.value.value = '';
                files.photo = null; files.attachments = [];
                
                showSuccessModal.value = true;

            } catch (e) {
                errorMsg.value = "æäº¤å¤±æ•—: " + e.message;
            } finally { 
                loading.value = false; 
            }
        };
        
        const closeSuccessModal = () => { 
            showSuccessModal.value = false; 
            previewPhotoUrl.value = ''; 
        };

        const openPrintView = (data, photoUrl) => {
            const printWindow = window.open('', '_blank');
            const formattedTime = formatTime(data.eta_datetime, true);
            // [FIX] ç¢ºä¿åˆ—å°é é¢ä¹Ÿä½¿ç”¨å¯é¡¯ç¤ºçš„ URL
            const displayUrl = getDriveImgUrl(photoUrl);
            
            // Logic added here for differentiation
            const isProj = data.cap_bucket === 'proj';
            const pageTitle = isProj ? 'å°ˆæ¡ˆæ›è™Ÿæ†‘è­‰' : 'é ç´„å ±åˆ°æ†‘è­‰';
            const statusBadge = isProj 
                ? '<span style="background:#f3e8ff; color:#7e22ce; padding:4px 8px; border-radius:4px; font-size:12px; border:1px solid #d8b4fe;">å°ˆæ¡ˆæ›è™Ÿ PROJ</span>'
                : '<span style="background:#dbeafe; color:#1d4ed8; padding:4px 8px; border-radius:4px; font-size:12px; border:1px solid #93c5fd;">ä¸€èˆ¬é ç´„ STD</span>';
            
            const alertBox = isProj
                ? `<div style="margin-bottom:20px; padding:15px; background-color:#faf5ff; border:2px dashed #a855f7; color:#6b21a8; font-weight:bold; text-align:center; border-radius:8px;">
                     <i class="fa-solid fa-triangle-exclamation"></i> ç‰¹æ®Š/å°ˆæ¡ˆæ›è™Ÿæé†’<br>
                     <span style="font-size:14px; font-weight:normal; color:#581c87;">æœ¬æ™‚æ®µæ¨™æº–è»Šä½å·²æ»¿æˆ–ç‚ºç¾å ´æ›è™Ÿï¼Œ<br>è«‹ä¾ç¾å ´äººå“¡æŒ‡ç¤ºå¼•å°ï¼Œéœ€ç­‰å€™èª¿åº¦å®‰æ’ã€‚</span>
                   </div>`
                : `<div style="margin-bottom:20px; padding:15px; background-color:#f0f9ff; border:1px solid #bae6fd; color:#0369a1; text-align:center; border-radius:8px;">
                     <i class="fa-solid fa-circle-check"></i> é ç´„ç¢ºèª<br>
                     <span style="font-size:14px; font-weight:normal;">ç³»çµ±å·²ä¿ç•™æ‚¨çš„æ™‚æ®µï¼Œè«‹æº–æ™‚æŠµé”ã€‚</span>
                   </div>`;

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-TW">
                <head>
                    <meta charset="UTF-8">
                    <title>${pageTitle} - ${data.plate_manual}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        body { font-family: sans-serif; background-color: white; padding: 20px; }
                        .print-container { max-width: 800px; margin: 0 auto; border: 2px solid #333; padding: 30px; border-radius: 8px; }
                        .header { text-align: center; border-bottom: 2px solid #ddd; padding-bottom: 20px; margin-bottom: 20px; }
                        .header h1 { font-size: 24px; font-weight: bold; color: #1e293b; margin-bottom: 5px; }
                        .header p { color: #64748b; margin-top: 5px; font-size: 12px; }
                        .grid-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding: 12px 0; align-items: center; }
                        .label { font-weight: bold; color: #64748b; width: 120px; }
                        .value { font-weight: bold; color: #1e293b; flex: 1; text-align: right; }
                        .photo-box { margin-top: 20px; text-align: center; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; }
                        .photo-box img { max-width: 100%; max-height: 400px; height: auto; border-radius: 4px; }
                        @media print {
                            body { padding: 0; background: white; }
                            .print-container { border: none; padding: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <div class="header">
                            <h1>${pageTitle}</h1>
                            ${statusBadge}
                            <p style="margin-top:10px;">åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString()}</p>
                        </div>
                        
                        ${alertBox}

                        <div class="grid-row"><span class="label">é ç´„å–®è™Ÿ</span><span class="value font-mono">${data.booking_id || '-'}</span></div>
                        <div class="grid-row"><span class="label">é è¨ˆåˆ°é”</span><span class="value font-mono">${formattedTime}</span></div>
                        <div class="grid-row"><span class="label">è»Šç‰Œè™Ÿç¢¼</span><span class="value text-xl">${data.plate_manual}</span></div>
                        <div class="grid-row"><span class="label">å¸æ©Ÿå§“å</span><span class="value">${data.driver_name}</span></div>
                        <div class="grid-row"><span class="label">ç‰©æµå…¬å¸</span><span class="value">${data.logistics_company}</span></div>
                        <div class="grid-row"><span class="label">è¯çµ¡é›»è©±</span><span class="value font-mono">${data.phone}</span></div>
                        <div class="grid-row"><span class="label">å‚™è¨»äº‹é …</span><span class="value">${data.note || 'ç„¡'}</span></div>
                        
                        <div class="photo-box">
                            <div style="font-weight:bold; margin-bottom:10px; color:#475569;">ç¾å ´ç…§ç‰‡ç´€éŒ„</div>
                            ${displayUrl ? `<img src="${displayUrl}" referrerpolicy="no-referrer" alt="ç¾å ´ç…§ç‰‡">` : '<div style="color:#94a3b8; padding:20px;">ç„¡ç…§ç‰‡è³‡æ–™</div>'}
                        </div>
                    </div>
                    <div class="fixed bottom-4 right-4 no-print flex gap-2">
                        <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg font-bold hover:bg-blue-700 transition"><i class="fa-solid fa-print mr-2"></i>åˆ—å°æœ¬é </button>
                        <button onclick="window.close()" class="bg-gray-500 text-white px-6 py-3 rounded-full shadow-lg font-bold hover:bg-gray-600 transition">é—œé–‰</button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
        };

        const handleAdminClick = () => {
            if (isAdminLoggedIn.value) { switchToAdmin(); } else { view.value = 'admin_login'; errorMsg.value = ''; nextTick(() => { if(loginInput.value) loginInput.value.focus(); }); }
        };

        const submitLogin = async () => {
            loading.value = true; loadingText.value = "é©—è­‰èº«ä»½...";
            errorMsg.value = '';
            try {
                if (adminPasswordInput.value === 'demo123') { isAdminLoggedIn.value = true; adminPasswordInput.value = ''; switchToAdmin(); return; }
                await callApi({ action: 'verify_password', password: adminPasswordInput.value });
                isAdminLoggedIn.value = true; adminPasswordInput.value = ''; switchToAdmin();
            } catch(e) {
                errorMsg.value = "ç™»å…¥å¤±æ•—: " + e.message;
            } finally { loading.value = false; }
        };

        const logout = () => { isAdminLoggedIn.value = false; view.value = 'driver'; };
        const switchToAdmin = () => { if(!isAdminLoggedIn.value) { view.value = 'admin_login'; return; } view.value = 'admin'; fetchAdminData(); };

        const fetchAdminData = async () => {
            loading.value = true; loadingText.value = "è¼‰å…¥æˆ°æƒ…æ•¸æ“š...";
            try {
                const p1 = callApi({ action: 'summary', date: adminDate.value });
                const p2 = callApi({ action: 'list', date: adminDate.value });
                const [resSum, resList] = await Promise.all([p1, p2]);
                capacityGrid.value = resSum.data || {};
                bookingList.value = Array.isArray(resList.data) ? resList.data : [];
            } catch (e) { errorMsg.value = "è®€å–å¤±æ•—: " + e.message; } finally { loading.value = false; }
        };

        const sortedBookingList = computed(() => {
            if (!bookingList.value) return [];
            return [...bookingList.value].sort((a, b) => {
                const tUpdateA = a.created_at_sys || a.upload_time_sys || '';
                const tUpdateB = b.created_at_sys || b.upload_time_sys || '';
                const tEtaA = a.eta_datetime || '';
                const tEtaB = b.eta_datetime || '';

                switch (sortMode.value) {
                    case 'update_desc': return tUpdateB.localeCompare(tUpdateA);
                    case 'update_asc': return tUpdateA.localeCompare(tUpdateB);
                    case 'time_desc': return tEtaB.localeCompare(tEtaA);
                    case 'time_asc': return tEtaA.localeCompare(tEtaB);
                    default: return 0;
                }
            });
        });

        const toggleSortOrder = () => {
            const cycle = ['update_desc', 'update_asc', 'time_desc', 'time_asc'];
            const idx = cycle.indexOf(sortMode.value);
            sortMode.value = cycle[(idx + 1) % cycle.length];
        };

        const getSortLabel = () => {
            switch (sortMode.value) {
                case 'update_desc': return 'æ›´æ–° â†“'; 
                case 'update_asc': return 'æ›´æ–° â†‘'; 
                case 'time_desc': return 'æ™‚é–“ â†“'; 
                case 'time_asc': return 'æ™‚é–“ â†‘'; 
            }
        };

        const toggleBucket = async (item) => {
            const newBucket = (item.cap_bucket || 'std') === 'std' ? 'proj' : 'std';
            loading.value = true; loadingText.value = "åˆ‡æ›åˆ†é…...";
            try { await callApi({ action: 'set_bucket', booking_id: item.id || item.booking_id, new_cap_bucket: newBucket }); item.cap_bucket = newBucket; await fetchAdminData(); } catch(e) { alert(e.message); } finally { loading.value = false; }
        };

        const getSlot = (hour) => { const hh = String(hour).padStart(2, '0'); const key = adminDate.value + 'T' + hh; return capacityGrid.value[key] || null; };
        const openCapEdit = (slot) => { if(!slot) return; editingSlot.value = slot; tempCap.std = slot.cap_std; tempCap.proj = slot.cap_proj; };
        const saveCap = async () => {
            loading.value = true; loadingText.value = "æ›´æ–°ä¸Šé™...";
            try { await callApi({ action: 'set_capacity_limit', window_key: editingSlot.value.window_key, cap_std: tempCap.std, cap_proj: tempCap.proj }); editingSlot.value = null; await fetchAdminData(); } catch(e) { alert(e.message); } finally { loading.value = false; }
        };

        const viewDetail = (booking) => { 
            selectedBooking.value = booking; 
        };
        
        const formatTime = (isoString, showFull = false) => {
            if (!isoString) return '--:--';
            try { 
                if (isoString.length === 5 && isoString.includes(':')) return isoString; 
                const d = new Date(isoString); 
                if (isNaN(d.getTime())) return isoString; 
                if (showFull) {
                    return `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
                }
                return d.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }); 
            } catch (e) { return isoString; }
        };
        
        const parseAttachments = (attStr) => {
            if(!attStr) return [];
            if(Array.isArray(attStr)) return attStr;
            const items = attStr.split('|||');
            return items.map((item, idx) => { const isUrl = item.startsWith('http'); const url = isUrl ? item : `https://drive.google.com/file/d/${item}/view?usp=drivesdk`; return { name: `é™„ä»¶ ${idx+1}`, url: url }; });
        };
        const pct = (u, c) => Math.min(100, (c > 0 ? (u/c)*100 : 0));

        onMounted(() => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const twTime = new Date(utc + (3600000 * 8));
            twTime.setHours(twTime.getHours() + 1, 0, 0, 0); 
            form.eta_datetime = twTime.toISOString().slice(0, 16);
        });

        return {
            view, loading, loadingText, errorMsg, showSuccessModal, form, files, photoInput, attInput, adminDate,
            capacityGrid, bookingList, sortedBookingList, editingSlot, tempCap, selectedBooking, isAdminLoggedIn, adminPasswordInput, loginInput,
            isAutoSwitchedToProj, lastSubmittedData, previewPhotoUrl, sortMode, 
            fillDemo, handleFile, submitBooking, closeSuccessModal, openPrintView, handleAdminClick, submitLogin, logout, 
            switchToAdmin, fetchAdminData, toggleBucket, openCapEdit, saveCap, viewDetail, pct, formatTime, parseAttachments, getSlot,
            toggleSortOrder, getSortLabel, getDriveImgUrl 
        };
    }
}).mount('#app');
</script>
</body>
</html>